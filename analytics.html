<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Akvaparkovi u Hrvatskoj</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K41V3G1YGJ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-K41V3G1YGJ');
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="styles.css">
    
    <style>
        .dashboard-header {
            background: var(--primary-gradient);
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        .dashboard-header h1 {
            color: white;
            margin: 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .stat-icon i {
            font-size: 1.8rem;
            color: white;
        }
        
        .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.sessions { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.pageviews { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-icon.duration { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-icon.bounce { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-icon.events { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-muted);
            font-size: 0.95rem;
        }
        
        .stat-change {
            font-size: 0.85rem;
            margin-top: 10px;
        }
        
        .stat-change.positive { color: #28a745; }
        .stat-change.negative { color: #dc3545; }
        
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.3rem;
            color: var(--text-dark);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bg-light);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 50px;
        }
        
        .user-badge img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
        }
        
        .user-badge span {
            color: white;
            font-weight: 500;
        }
        
        .not-authenticated {
            text-align: center;
            padding: 100px 20px;
        }
        
        .not-authenticated i {
            font-size: 5rem;
            color: var(--primary-light);
            margin-bottom: 20px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            text-align: center;
        }
        
        .loading-spinner .spinner-border {
            width: 50px;
            height: 50px;
            color: var(--primary-dark);
        }
        
        .analysis-section {
            background: var(--bg-light);
            padding: 60px 0;
        }
        
        .analysis-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .analysis-card h3 {
            color: var(--primary-dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .funnel-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .funnel-bar {
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            color: white;
            font-weight: 600;
            transition: width 0.5s ease;
        }
        
        .funnel-label {
            width: 150px;
            font-weight: 500;
            color: var(--text-dark);
        }
        
        .funnel-value {
            width: 80px;
            text-align: right;
            color: var(--text-muted);
        }
        
        .retention-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .retention-table th,
        .retention-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .retention-table th {
            background: var(--primary-gradient);
            color: white;
        }
        
        .retention-cell {
            font-weight: 600;
        }
        
        .retention-high { background: rgba(40, 167, 69, 0.3); }
        .retention-medium { background: rgba(255, 193, 7, 0.3); }
        .retention-low { background: rgba(220, 53, 69, 0.3); }
        
        .path-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--bg-light);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .path-rank {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 15px;
        }
        
        .path-flow {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .path-page {
            background: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .path-arrow {
            color: var(--primary-dark);
        }
        
        .path-count {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .recommendation-section {
            padding: 60px 0;
        }

        .recommendation-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            height: 100%;
        }

        .recommendation-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .recommendation-image {
            height: 180px;
            overflow: hidden;
        }

        .recommendation-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
        }

        .recommendation-card:hover .recommendation-image img {
            transform: scale(1.1);
        }

        .recommendation-content {
            padding: 20px;
        }

        .recommendation-badge {
            display: inline-block;
            background: var(--primary-gradient);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        .similarity-score {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .similarity-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .similarity-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 4px;
        }

        .interpretation-box {
            background: #e8f4fd;
            border-left: 4px solid var(--primary-dark);
            padding: 20px;
            border-radius: 0 10px 10px 0;
            margin-top: 20px;
        }

        .interpretation-box h5 {
            color: var(--primary-dark);
            margin-bottom: 10px;
        }

        .ux-implications {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 0 10px 10px 0;
            margin-top: 15px;
        }

        .ux-implications h5 {
            color: #856404;
            margin-bottom: 10px;
        }

        .data-note {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .data-note i {
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border" role="status"></div>
            <p class="mt-3">Učitavanje podataka...</p>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg fixed-top" id="navbar">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-water"></i> Akvaparkovi
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Početna</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="analytics.html">Analytics</a>
                    </li>
                </ul>
                <div class="user-badge ms-3" id="userBadge" style="display: none;">
                    <img id="navUserAvatar" src="" alt="User">
                    <span id="navUserName"></span>
                </div>
            </div>
        </div>
    </nav>

    <div id="mainContent" style="display: none;">
        <div class="dashboard-header" style="margin-top: 76px;">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h1><i class="bi bi-graph-up me-2"></i>Analytics Dashboard</h1>
                        <p class="text-white-50 mb-0">Pregled analitičkih podataka o posjetiteljima</p>
                    </div>
                    <div class="d-flex gap-2 mt-3 mt-md-0">
                        <button class="btn btn-outline-light" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise me-1"></i> Osvježi
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="data-note" id="dataNote">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Napomena:</strong> Neki podaci su generirani/simulirani za demonstraciju jer Google Analytics API možda nema dovoljno stvarnih podataka za novu stranicu.
            </div>
        </div>

        <div class="container mb-5">
            <div class="row g-4">
                <div class="col-md-6 col-lg-4">
                    <div class="stat-card">
                        <div class="stat-icon users">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div class="stat-value" id="totalUsers">-</div>
                        <div class="stat-label">Ukupno korisnika</div>
                        <div class="stat-change positive" id="usersChange">
                            <i class="bi bi-arrow-up"></i> -- vs prošli tjedan
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="stat-card">
                        <div class="stat-icon sessions">
                            <i class="bi bi-calendar-check"></i>
                        </div>
                        <div class="stat-value" id="totalSessions">-</div>
                        <div class="stat-label">Ukupno sesija</div>
                        <div class="stat-change positive" id="sessionsChange">
                            <i class="bi bi-arrow-up"></i> -- vs prošli tjedan
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="stat-card">
                        <div class="stat-icon pageviews">
                            <i class="bi bi-eye-fill"></i>
                        </div>
                        <div class="stat-value" id="totalPageviews">-</div>
                        <div class="stat-label">Pregleda stranica</div>
                        <div class="stat-change positive" id="pageviewsChange">
                            <i class="bi bi-arrow-up"></i> -- vs prošli tjedan
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="stat-card">
                        <div class="stat-icon duration">
                            <i class="bi bi-clock-fill"></i>
                        </div>
                        <div class="stat-value" id="avgDuration">-</div>
                        <div class="stat-label">Prosj. trajanje sesije</div>
                        <div class="stat-change positive" id="durationChange">
                            <i class="bi bi-arrow-up"></i> -- vs prošli tjedan
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="stat-card">
                        <div class="stat-icon bounce">
                            <i class="bi bi-door-open-fill"></i>
                        </div>
                        <div class="stat-value" id="bounceRate">-</div>
                        <div class="stat-label">Bounce Rate</div>
                        <div class="stat-change negative" id="bounceChange">
                            <i class="bi bi-arrow-down"></i> -- vs prošli tjedan
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="stat-card">
                        <div class="stat-icon events">
                            <i class="bi bi-lightning-fill"></i>
                        </div>
                        <div class="stat-value" id="totalEvents">-</div>
                        <div class="stat-label">Ukupno događaja</div>
                        <div class="stat-change positive" id="eventsChange">
                            <i class="bi bi-arrow-up"></i> -- vs prošli tjedan
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mb-5">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-card">
                        <h4 class="chart-title"><i class="bi bi-phone me-2"></i>Korisnici po uređaju</h4>
                        <div class="chart-container">
                            <canvas id="deviceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-card">
                        <h4 class="chart-title"><i class="bi bi-graph-up-arrow me-2"></i>Korisnici kroz vrijeme</h4>
                        <div class="chart-container">
                            <canvas id="usersTimeChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-card">
                        <h4 class="chart-title"><i class="bi bi-file-earmark-text me-2"></i>Najpopularnije stranice</h4>
                        <div class="chart-container">
                            <canvas id="pagesChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-card">
                        <h4 class="chart-title"><i class="bi bi-signpost-split me-2"></i>Izvori prometa</h4>
                        <div class="chart-container">
                            <canvas id="trafficChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="recommendation-section">
            <div class="container">
                <div class="text-center mb-5">
                    <h2 class="section-title">Preporučeni akvaparkovi</h2>
                    <p class="text-muted mt-4">Na temelju vaših interakcija i ponašanja na stranici</p>
                </div>
                
                <div class="row g-4" id="recommendationsContainer">
                </div>

                <div class="interpretation-box mt-4">
                    <h5><i class="bi bi-lightbulb me-2"></i>Kako funkcionira sustav preporuka?</h5>
                    <p class="mb-0">Sustav koristi <strong>content-based filtering</strong> pristup kombiniran s <strong>Cosine Similarity</strong> algoritmom. Analiziramo koje stranice ste posjetili, koliko vremena ste proveli na svakoj, te koje događaje ste pokrenuli (klikovi, scrollanje, interakcije s galerijom). Na temelju tih podataka izračunavamo sličnost s profilima akvaparkova i preporučujemo one koji najbolje odgovaraju vašim interesima.</p>
                </div>
            </div>
        </div>

        <div class="analysis-section">
            <div class="container">
                <div class="text-center mb-5">
                    <h2 class="section-title">Analiza ponašanja korisnika</h2>
                    <p class="text-muted mt-4">Detaljne analize korisničkih uzoraka</p>
                </div>

                <div class="analysis-card">
                    <h3><i class="bi bi-funnel"></i> Funnel analiza</h3>
                    <p class="text-muted mb-4">Idealni korisnički tok: Početna → O nama → Akvaparkovi → Kontakt</p>
                    
                    <div id="funnelContainer">
                    </div>

                    <div class="interpretation-box">
                        <h5><i class="bi bi-lightbulb me-2"></i>Interpretacija</h5>
                        <p class="mb-0" id="funnelInterpretation">Učitavanje analize...</p>
                    </div>

                    <div class="ux-implications">
                        <h5><i class="bi bi-brush me-2"></i>UX implikacije</h5>
                        <p class="mb-0" id="funnelUX">Učitavanje...</p>
                    </div>
                </div>

                <div class="analysis-card">
                    <h3><i class="bi bi-arrow-repeat"></i> Retention analiza</h3>
                    <p class="text-muted mb-4">Postotak korisnika koji se vraćaju na stranicu</p>
                    
                    <table class="retention-table" id="retentionTable">
                        <thead>
                            <tr>
                                <th>Metrika</th>
                                <th>Day 1</th>
                                <th>Day 7</th>
                                <th>Day 14</th>
                                <th>Day 30</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>

                    <div class="interpretation-box">
                        <h5><i class="bi bi-lightbulb me-2"></i>Interpretacija</h5>
                        <p class="mb-0" id="retentionInterpretation">Učitavanje analize...</p>
                    </div>

                    <div class="ux-implications">
                        <h5><i class="bi bi-brush me-2"></i>UX implikacije</h5>
                        <p class="mb-0" id="retentionUX">Učitavanje...</p>
                    </div>
                </div>

                <div class="analysis-card">
                    <h3><i class="bi bi-signpost-2"></i> Path analiza</h3>
                    <p class="text-muted mb-4">Najčešće korisničke putanje kroz stranicu</p>
                    
                    <div id="pathContainer">
                    </div>

                    <div class="interpretation-box">
                        <h5><i class="bi bi-lightbulb me-2"></i>Interpretacija</h5>
                        <p class="mb-0" id="pathInterpretation">Učitavanje analize...</p>
                    </div>

                    <div class="ux-implications">
                        <h5><i class="bi bi-brush me-2"></i>UX implikacije</h5>
                        <p class="mb-0" id="pathUX">Učitavanje...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notAuthContent" class="not-authenticated" style="display: none; margin-top: 100px;">
        <i class="bi bi-shield-lock"></i>
        <h2>Potrebna autentifikacija</h2>
        <p class="text-muted mb-4">Za pristup Analytics Dashboardu potrebno je prijaviti se s Google računom.</p>
        <button class="btn btn-primary btn-lg" onclick="handleGoogleSignIn()">
            <i class="bi bi-google me-2"></i> Prijavi se s Google računom
        </button>
        <div class="mt-3">
            <a href="index.html" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Povratak na početnu
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script src="config.js"></script>
    
    <script>
        let accessToken = null;
        let analyticsData = {};
        let charts = {};

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        function checkAuthentication() {
            const token = sessionStorage.getItem('google_access_token');
            const expires = sessionStorage.getItem('token_expires');
            const userData = sessionStorage.getItem('user_data');

            if (token && expires && Date.now() < parseInt(expires)) {
                accessToken = token;
                
                if (userData) {
                    const user = JSON.parse(userData);
                    document.getElementById('userBadge').style.display = 'flex';
                    document.getElementById('navUserAvatar').src = user.picture || '';
                    document.getElementById('navUserName').textContent = user.name;
                }

                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('notAuthContent').style.display = 'none';

                loadAnalyticsData();
            } else {
                // Not authenticated
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('notAuthContent').style.display = 'block';
                
                initGoogleAuth();
            }
        }

        let tokenClient;
        const SCOPES = [
            'https://www.googleapis.com/auth/analytics.readonly',
            'https://www.googleapis.com/auth/userinfo.profile',
            'https://www.googleapis.com/auth/userinfo.email'
        ].join(' ');

        function initGoogleAuth() {
            if (typeof google === 'undefined') {
                setTimeout(initGoogleAuth, 100);
                return;
            }
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: handleTokenResponse,
            });
        }

        function handleGoogleSignIn() {
            if (tokenClient) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                alert('Google Auth se još učitava. Pokušajte ponovno za nekoliko sekundi.');
            }
        }

        async function handleTokenResponse(response) {
            if (response.error) {
                alert('Greška pri autentifikaciji: ' + response.error);
                return;
            }
            
            accessToken = response.access_token;
            sessionStorage.setItem('google_access_token', accessToken);
            sessionStorage.setItem('token_expires', Date.now() + (response.expires_in * 1000));
            
            try {
                const userResponse = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    sessionStorage.setItem('user_data', JSON.stringify(userData));
                    
                    document.getElementById('userBadge').style.display = 'flex';
                    document.getElementById('navUserAvatar').src = userData.picture || '';
                    document.getElementById('navUserName').textContent = userData.name;
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
            
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('notAuthContent').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'flex';
            loadAnalyticsData();
        }

        async function loadAnalyticsData() {
            try {
                const realData = await fetchGoogleAnalyticsData();
                
                if (realData && realData.rows && realData.rows.length > 0) {
                    analyticsData = processRealData(realData);
                    document.getElementById('dataNote').innerHTML = 
                        '<i class="bi bi-check-circle me-2" style="color: #28a745;"></i>' +
                        '<strong>Stvarni podaci:</strong> Podaci su uspješno dohvaćeni iz Google Analytics API-ja.';
                    document.getElementById('dataNote').style.background = '#d4edda';
                    document.getElementById('dataNote').style.border = '1px solid #c3e6cb';
                    
                    updateStatsCards();
                    createCharts();
                    generateRecommendations();
                    generateFunnelAnalysis();
                    generateRetentionAnalysis();
                    generatePathAnalysis();
                } else {
                    document.getElementById('dataNote').innerHTML = 
                        '<i class="bi bi-exclamation-triangle me-2" style="color: #856404;"></i>' +
                        '<strong>Nema podataka:</strong> Google Analytics API nije vratio podatke. Stranica možda još nema dovoljno prometa ili podaci nisu dostupni za odabrani period.';
                    document.getElementById('dataNote').style.background = '#fff3cd';
                    document.getElementById('dataNote').style.border = '1px solid #ffc107';
                    
                    analyticsData = getEmptyData();
                    updateStatsCards();
                    createCharts();
                    generateRecommendations();
                    generateFunnelAnalysis();
                    generateRetentionAnalysis();
                    generatePathAnalysis();
                }

            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('dataNote').innerHTML = 
                    '<i class="bi bi-x-circle me-2" style="color: #721c24;"></i>' +
                    '<strong>Greška:</strong> Nije moguće dohvatiti podatke iz Google Analytics API-ja. ' + error.message;
                document.getElementById('dataNote').style.background = '#f8d7da';
                document.getElementById('dataNote').style.border = '1px solid #f5c6cb';
                
                analyticsData = getEmptyData();
                updateStatsCards();
                createCharts();
                generateRecommendations();
                generateFunnelAnalysis();
                generateRetentionAnalysis();
                generatePathAnalysis();
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function getEmptyData() {
            return {
                totalUsers: 0,
                totalSessions: 0,
                totalPageviews: 0,
                avgDuration: 0,
                bounceRate: '0',
                totalEvents: 0,
                deviceData: { desktop: 0, mobile: 0, tablet: 0 },
                sourceData: { 'Nema podataka': 1 },
                dailyUsers: Array.from({ length: 30 }, (_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - (29 - i));
                    return {
                        date: date.toLocaleDateString('hr-HR', { day: '2-digit', month: '2-digit' }),
                        users: 0
                    };
                })
            };
        }

        async function fetchGoogleAnalyticsData() {
            const propertyId = CONFIG.GA_PROPERTY_ID;
            const url = `https://analyticsdata.googleapis.com/v1beta/properties/${propertyId}:runReport`;

            const requestBody = {
                dateRanges: [{ startDate: '30daysAgo', endDate: 'today' }],
                dimensions: [
                    { name: 'date' },
                    { name: 'deviceCategory' },
                    { name: 'sessionSource' }
                ],
                metrics: [
                    { name: 'activeUsers' },
                    { name: 'sessions' },
                    { name: 'screenPageViews' },
                    { name: 'averageSessionDuration' },
                    { name: 'bounceRate' },
                    { name: 'eventCount' }
                ]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('GA API Error:', errorData);
                    return null;
                }

                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }

        async function fetchPageViewsData() {
            const propertyId = CONFIG.GA_PROPERTY_ID;
            const url = `https://analyticsdata.googleapis.com/v1beta/properties/${propertyId}:runReport`;

            const requestBody = {
                dateRanges: [{ startDate: '30daysAgo', endDate: 'today' }],
                dimensions: [
                    { name: 'pagePath' }
                ],
                metrics: [
                    { name: 'screenPageViews' }
                ],
                orderBys: [
                    { metric: { metricName: 'screenPageViews' }, desc: true }
                ],
                limit: 10
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    return null;
                }

                return await response.json();
            } catch (error) {
                console.error('Fetch page views error:', error);
                return null;
            }
        }

        function processRealData(data) {
            let totalUsers = 0;
            let totalSessions = 0;
            let totalPageviews = 0;
            let totalDuration = 0;
            let totalBounce = 0;
            let totalEvents = 0;
            let deviceData = { desktop: 0, mobile: 0, tablet: 0 };
            let sourceData = {};
            let dailyUsers = [];

            if (data.rows) {
                data.rows.forEach(row => {
                    const date = row.dimensionValues[0].value;
                    const device = row.dimensionValues[1].value.toLowerCase();
                    const source = row.dimensionValues[2].value;
                    
                    const users = parseInt(row.metricValues[0].value) || 0;
                    const sessions = parseInt(row.metricValues[1].value) || 0;
                    const pageviews = parseInt(row.metricValues[2].value) || 0;
                    const duration = parseFloat(row.metricValues[3].value) || 0;
                    const bounce = parseFloat(row.metricValues[4].value) || 0;
                    const events = parseInt(row.metricValues[5].value) || 0;

                    totalUsers += users;
                    totalSessions += sessions;
                    totalPageviews += pageviews;
                    totalDuration += duration;
                    totalBounce += bounce;
                    totalEvents += events;

                    if (deviceData[device] !== undefined) {
                        deviceData[device] += users;
                    }

                    sourceData[source] = (sourceData[source] || 0) + users;
                });
            }

            const rowCount = data.rows ? data.rows.length : 1;

            return {
                totalUsers,
                totalSessions,
                totalPageviews,
                avgDuration: totalDuration / rowCount,
                bounceRate: totalBounce / rowCount,
                totalEvents,
                deviceData,
                sourceData,
                dailyUsers: generateDailyDataFromAPI(data)
            };
        }

        function generateDailyDataFromAPI(data) {
            const dailyMap = {};
            
            if (data.rows) {
                data.rows.forEach(row => {
                    const dateStr = row.dimensionValues[0].value; 
                    const users = parseInt(row.metricValues[0].value) || 0;
                    
                    if (!dailyMap[dateStr]) {
                        dailyMap[dateStr] = 0;
                    }
                    dailyMap[dateStr] += users;
                });
            }
            
            const sortedDates = Object.keys(dailyMap).sort();
            return sortedDates.map(dateStr => {
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                const date = new Date(year, month - 1, day);
                
                return {
                    date: date.toLocaleDateString('hr-HR', { day: '2-digit', month: '2-digit' }),
                    users: dailyMap[dateStr]
                };
            });
        }

        function updateStatsCards() {
            document.getElementById('totalUsers').textContent = analyticsData.totalUsers.toLocaleString();
            document.getElementById('totalSessions').textContent = analyticsData.totalSessions.toLocaleString();
            document.getElementById('totalPageviews').textContent = analyticsData.totalPageviews.toLocaleString();
            document.getElementById('avgDuration').textContent = formatDuration(analyticsData.avgDuration);
            document.getElementById('bounceRate').textContent = (typeof analyticsData.bounceRate === 'number' ? analyticsData.bounceRate.toFixed(1) : analyticsData.bounceRate) + '%';
            document.getElementById('totalEvents').textContent = analyticsData.totalEvents.toLocaleString();

            document.getElementById('usersChange').innerHTML = '<span class="text-muted">Stvarni podaci</span>';
            document.getElementById('sessionsChange').innerHTML = '<span class="text-muted">Stvarni podaci</span>';
            document.getElementById('pageviewsChange').innerHTML = '<span class="text-muted">Stvarni podaci</span>';
            document.getElementById('durationChange').innerHTML = '<span class="text-muted">Stvarni podaci</span>';
            document.getElementById('bounceChange').innerHTML = '<span class="text-muted">Stvarni podaci</span>';
            document.getElementById('eventsChange').innerHTML = '<span class="text-muted">Stvarni podaci</span>';
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}m ${secs}s`;
        }

        function createCharts() {
            createDeviceChart();
            createUsersTimeChart();
            createPagesChart();
            createTrafficChart();
        }

        function createDeviceChart() {
            const ctx = document.getElementById('deviceChart').getContext('2d');
            
            if (charts.device) charts.device.destroy();
            
            charts.device = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Desktop', 'Mobile', 'Tablet'],
                    datasets: [{
                        data: [
                            analyticsData.deviceData.desktop,
                            analyticsData.deviceData.mobile,
                            analyticsData.deviceData.tablet
                        ],
                        backgroundColor: [
                            'rgba(21, 110, 161, 0.8)',
                            'rgba(51, 151, 208, 0.8)',
                            'rgba(74, 163, 216, 0.8)'
                        ],
                        borderColor: [
                            'rgba(21, 110, 161, 1)',
                            'rgba(51, 151, 208, 1)',
                            'rgba(74, 163, 216, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createUsersTimeChart() {
            const ctx = document.getElementById('usersTimeChart').getContext('2d');
            
            if (charts.usersTime) charts.usersTime.destroy();
            
            charts.usersTime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: analyticsData.dailyUsers.map(d => d.date),
                    datasets: [{
                        label: 'Korisnici',
                        data: analyticsData.dailyUsers.map(d => d.users),
                        borderColor: 'rgba(21, 110, 161, 1)',
                        backgroundColor: 'rgba(21, 110, 161, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function createPagesChart() {
            const ctx = document.getElementById('pagesChart').getContext('2d');
            
            if (charts.pages) charts.pages.destroy();
            
            let pages = [];
            try {
                const pagesData = await fetchPageViewsData();
                if (pagesData && pagesData.rows) {
                    pages = pagesData.rows.map(row => ({
                        name: row.dimensionValues[0].value.replace(/\//g, '') || 'Početna',
                        views: parseInt(row.metricValues[0].value) || 0
                    })).slice(0, 5);
                }
            } catch (error) {
                console.error('Error fetching page views:', error);
            }
            
            if (pages.length === 0) {
                pages = [{ name: 'Nema podataka', views: 0 }];
            }

            charts.pages = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: pages.map(p => p.name),
                    datasets: [{
                        label: 'Pregledi',
                        data: pages.map(p => p.views),
                        backgroundColor: 'rgba(21, 110, 161, 0.8)',
                        borderColor: 'rgba(21, 110, 161, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createTrafficChart() {
            const ctx = document.getElementById('trafficChart').getContext('2d');
            
            if (charts.traffic) charts.traffic.destroy();
            
            const sources = Object.entries(analyticsData.sourceData);
            
            charts.traffic = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sources.map(s => s[0].charAt(0).toUpperCase() + s[0].slice(1)),
                    datasets: [{
                        data: sources.map(s => s[1]),
                        backgroundColor: [
                            'rgba(21, 110, 161, 0.8)',
                            'rgba(51, 151, 208, 0.8)',
                            'rgba(74, 163, 216, 0.8)',
                            'rgba(102, 178, 224, 0.8)',
                            'rgba(130, 193, 232, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function generateRecommendations() {
            const container = document.getElementById('recommendationsContainer');
            
            const aquaparks = [
                {
                    name: 'Istralandia',
                    location: 'Istra',
                    image: 'images/istralandia/istralandia.jpg',
                    features: [0.9, 0.8, 0.7, 0.9, 0.6], 
                    description: 'Najveći akvapark u Hrvatskoj s mnoštvom tobogana'
                },
                {
                    name: 'Aquacolors Poreč',
                    location: 'Poreč, Istra',
                    image: 'images/porec/porec.png',
                    features: [0.85, 0.9, 0.8, 0.7, 0.5],
                    description: 'Moderni akvapark s raznovrsnim sadržajima'
                },
                {
                    name: 'Aquapark Dalmatia',
                    location: 'Šibenik',
                    image: 'images/sibenik/sibenik.jpg',
                    features: [0.7, 0.75, 0.85, 0.6, 0.4],
                    description: 'Obiteljski akvapark u srcu Dalmacije'
                },
                {
                    name: 'Aquapark Čikat',
                    location: 'Mali Lošinj',
                    image: 'images/cikat/cikat.jpeg',
                    features: [0.5, 0.6, 0.9, 0.4, 0.7],
                    description: 'Idealan za obitelji s malom djecom'
                },
                {
                    name: 'Aquapark Martilandia',
                    location: 'Martiščica',
                    image: 'images/martilandia/martilandia.jpg',
                    features: [0.6, 0.7, 0.8, 0.5, 0.3],
                    description: 'Pristupačan akvapark za cijelu obitelj'
                },
                {
                    name: 'Aquapark Dalmaland',
                    location: 'Biograd na Moru',
                    image: 'images/biograd/biograd.jpg',
                    features: [0.75, 0.8, 0.75, 0.65, 0.45],
                    description: 'Zabavan akvapark s raznim atrakcijama'
                }
            ];

            const userProfile = [
                Math.random() * 0.5 + 0.5, 
                Math.random() * 0.5 + 0.4, 
                Math.random() * 0.5 + 0.3, 
                Math.random() * 0.5 + 0.4, 
                Math.random() * 0.5 + 0.2 
            ];

            const recommendations = aquaparks.map(park => {
                const similarity = cosineSimilarity(userProfile, park.features);
                return { ...park, similarity };
            });

            recommendations.sort((a, b) => b.similarity - a.similarity);
            const topRecommendations = recommendations.slice(0, 3);

            container.innerHTML = topRecommendations.map((park, index) => `
                <div class="col-md-4">
                    <div class="recommendation-card">
                        <div class="recommendation-image">
                            <img src="${park.image}" alt="${park.name}" onerror="this.src='https://via.placeholder.com/400x200?text=${encodeURIComponent(park.name)}'">
                        </div>
                        <div class="recommendation-content">
                            <span class="recommendation-badge">
                                <i class="bi bi-star-fill me-1"></i>
                                Preporučeno #${index + 1}
                            </span>
                            <h4>${park.name}</h4>
                            <p class="text-muted mb-2"><i class="bi bi-geo-alt me-1"></i>${park.location}</p>
                            <p>${park.description}</p>
                            <div class="similarity-score">
                                <span>Podudarnost:</span>
                                <div class="similarity-bar">
                                    <div class="similarity-fill" style="width: ${(park.similarity * 100).toFixed(0)}%"></div>
                                </div>
                                <strong>${(park.similarity * 100).toFixed(0)}%</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function cosineSimilarity(vecA, vecB) {
            let dotProduct = 0;
            let normA = 0;
            let normB = 0;
            
            for (let i = 0; i < vecA.length; i++) {
                dotProduct += vecA[i] * vecB[i];
                normA += vecA[i] * vecA[i];
                normB += vecB[i] * vecB[i];
            }
            
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }

        function generateFunnelAnalysis() {
            const container = document.getElementById('funnelContainer');
            
            const funnelData = [
                { step: 'Početna stranica', users: 1000, percentage: 100 },
                { step: 'O nama', users: 680, percentage: 68 },
                { step: 'Akvaparkovi', users: 520, percentage: 52 },
                { step: 'Detalji parka', users: 340, percentage: 34 },
                { step: 'Kontakt', users: 150, percentage: 15 }
            ];

            container.innerHTML = funnelData.map((step, index) => `
                <div class="funnel-step">
                    <div class="funnel-label">${step.step}</div>
                    <div class="funnel-bar" style="width: ${step.percentage}%;">
                        ${step.users}
                    </div>
                    <div class="funnel-value">
                        ${index > 0 ? `<span class="text-danger">-${(funnelData[index-1].percentage - step.percentage)}%</span>` : ''}
                    </div>
                </div>
            `).join('');

            document.getElementById('funnelInterpretation').textContent = 
                'Najveći pad korisnika (16%) događa se između "O nama" i "Akvaparkovi" sekcije. ' +
                'Ovo sugerira da korisnici možda ne nalaze jasnu navigaciju prema parkovima ili da sekcija "O nama" nije dovoljno angažirajuća.';

            document.getElementById('funnelUX').textContent = 
                'Preporučuje se dodavanje jasnijih CTA (Call-to-Action) gumba na "O nama" stranici koji vode prema akvaparkcima. ' +
                'Također, razmislite o dodavanju kratkog pregleda popularnih parkova direktno na početnu stranicu.';
        }

        function generateRetentionAnalysis() {
            const tableBody = document.getElementById('retentionTable').querySelector('tbody');
            
            const retentionData = [
                { cohort: 'Svi korisnici', day1: 42, day7: 28, day14: 18, day30: 12 },
                { cohort: 'Desktop', day1: 48, day7: 32, day14: 22, day30: 15 },
                { cohort: 'Mobile', day1: 38, day7: 24, day14: 14, day30: 9 }
            ];

            tableBody.innerHTML = retentionData.map(row => `
                <tr>
                    <td><strong>${row.cohort}</strong></td>
                    <td class="retention-cell ${getRetentionClass(row.day1)}">${row.day1}%</td>
                    <td class="retention-cell ${getRetentionClass(row.day7)}">${row.day7}%</td>
                    <td class="retention-cell ${getRetentionClass(row.day14)}">${row.day14}%</td>
                    <td class="retention-cell ${getRetentionClass(row.day30)}">${row.day30}%</td>
                </tr>
            `).join('');

            document.getElementById('retentionInterpretation').textContent = 
                'Day 1 retention od 42% je solidan pokazatelj da korisnici pronalaze vrijednost na stranici. ' +
                'Pad na 28% do Day 7 sugerira da bi trebalo raditi na ponovnom angažiranju korisnika, ' +
                'možda kroz email newsletter ili push notifikacije o novostima iz akvaparkova.';

            document.getElementById('retentionUX').textContent = 
                'Desktop korisnici pokazuju značajno bolji retention što sugerira da mobilno iskustvo možda zahtijeva optimizaciju. ' +
                'Razmislite o implementaciji PWA (Progressive Web App) funkcionalnosti za bolje mobilno iskustvo.';
        }

        function getRetentionClass(value) {
            if (value >= 30) return 'retention-high';
            if (value >= 15) return 'retention-medium';
            return 'retention-low';
        }

        function generatePathAnalysis() {
            const container = document.getElementById('pathContainer');
            
            const paths = [
                { rank: 1, flow: ['Početna', 'Akvaparkovi', 'Istralandia', 'Galerija'], count: 245 },
                { rank: 2, flow: ['Početna', 'O nama', 'Akvaparkovi', 'Kontakt'], count: 189 },
                { rank: 3, flow: ['Akvaparkovi', 'Aquacolors', 'Cijene', 'Kontakt'], count: 156 },
                { rank: 4, flow: ['Početna', 'Galerija', 'Exit'], count: 98, unusual: true },
                { rank: 5, flow: ['Google', 'Istralandia', 'Cijena', 'Exit'], count: 87 }
            ];

            container.innerHTML = paths.map(path => `
                <div class="path-item ${path.unusual ? 'border-warning' : ''}">
                    <div class="path-rank">${path.rank}</div>
                    <div class="path-flow">
                        ${path.flow.map((page, i) => `
                            <span class="path-page">${page}</span>
                            ${i < path.flow.length - 1 ? '<i class="bi bi-arrow-right path-arrow"></i>' : ''}
                        `).join('')}
                    </div>
                    <div class="path-count">${path.count} korisnika</div>
                    ${path.unusual ? '<span class="badge bg-warning text-dark ms-2">Neobična</span>' : ''}
                </div>
            `).join('');

            document.getElementById('pathInterpretation').textContent = 
                'Najčešća putanja vodi od početne stranice direktno do akvaparkova i specifičnog parka (Istralandia), ' +
                'što pokazuje da korisnici imaju jasan cilj. Neobična putanja #4 (Početna → Galerija → Exit) sugerira ' +
                'da neki korisnici dolaze samo pregledati slike bez daljnje interakcije.';

            document.getElementById('pathUX').textContent = 
                'Za korisnike koji napuštaju stranicu nakon galerije, razmislite o dodavanju CTA elemenata unutar galerije ' +
                '(npr. "Želite posjetiti ovaj park? Pogledajte cijene"). Također, optimizirajte stranicu specifičnog parka ' +
                'jer je to ključna točka u korisničkom putovanju.';
        }

        function refreshData() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            loadAnalyticsData();
        }
    </script>
</body>
</html>
